<nav class="nav-bar">

  <!-- Left: Logo -->
  <a class="nav-logo" href="/">
    <img src="conn.png" alt="logo" />
  </a>

  <!-- Grow -->
  <div class="spacer"></div>


  <!-- If not logged in -->
  @if (!authService.isLoggedIn()) {
    <button mat-flat-button color="primary" routerLink="/login">
      Log in
    </button>
  }

  <!-- If logged in -->
  @if (authService.isLoggedIn()) {

    <!-- Message icon: menu (desktop) / page (mobile) -->
    <div class="messages-container">

      <!-- Message menu trigger (desktop and mobile) -->
      <button
        mat-icon-button
        [matMenuTriggerFor]="messagesMenu">
        <mat-icon>chat</mat-icon>
        @if(unreadCount() > 0) {
          <span class="badge">{{ unreadCount() }}</span>
        }
      </button>

      <!-- Desktop dropdown menu -->
      <mat-menu #messagesMenu="matMenu" panelClass="messages-menu-panel">
        <div class="menu-title">Recent Chats</div>

        @if (isLoadingChats()) {
          <div class="loading-state">
            <mat-icon class="spinner">hourglass_empty</mat-icon>
            <span>Loading chats...</span>
          </div>
        } @else if (chatsError()) {
          <div class="error-state">
            <mat-icon>error_outline</mat-icon>
            <span>{{ chatsError() }}</span>
          </div>
        } @else if (chats().length === 0) {
          <div class="empty-state">No recent chats</div>
        } @else {
          @for (chat of chats(); track chat.userId) {
            <button mat-menu-item (click)="openChat(chat.userId)">
              <div class="chat-item">
                <img class="chat-avatar" [src]="getChatAvatar(chat)" [alt]="getChatName(chat)" />
                <div class="chat-info">
                  <span class="chat-name">{{ getChatName(chat) }}</span>
                  @if (chat.lastMessage) {
                    <span class="last-message">{{ chat.lastMessage.content }}</span>
                  }
                </div>
              </div>
            </button>
          }
        }
      </mat-menu>
    </div>


    <!-- User avatar + dropdown -->
    <button mat-button [matMenuTriggerFor]="userMenu">
      <mat-icon>expand_more</mat-icon>
      <div class="avatar-card">
        <img class="avatar" [src]="avatar()" />
        <span>{{ username() }}</span>
      </div>
    </button>
    
    <mat-menu #userMenu="matMenu">
      <button mat-menu-item [routerLink]="['/profile/', userId()]">
        <mat-icon>person</mat-icon>
        <span>Profile</span>
      </button>

      <button mat-menu-item (click)="logOut()">
        <mat-icon>logout</mat-icon>
        <span>Log out</span>
      </button>
    </mat-menu>
  }

</nav>
